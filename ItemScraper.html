<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UEX Commodities Lookup</title>
  <style>
    body { font-family: Arial, sans-serif; background: #121212; color: #eee; padding: 20px; }
    h1 { color: #4FC3F7; }
    input, button { padding: 8px; font-size: 1rem; margin: 5px 0; border-radius: 5px; border: none; }
    input { width: 250px; }
    button { background-color: #4FC3F7; color: #111; cursor: pointer; }
    button:hover { background-color: #29B6F6; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; background-color: #1a1a1a; }
    th, td { padding: 8px; border: 1px solid #333; text-align: left; }
    th { background-color: #333; }
    tr:nth-child(even) { background-color: #222; }
    .not-found { margin-top: 20px; color: #f55; }
  </style>
</head>
<body>
  <h1>UEX Commodities Lookup</h1>

  <label>Commodity Name or Code:</label><br />
  <input type="text" id="commodityInput" placeholder="e.g. Aluminum or ALUMINUM_CODE" />
  <button id="lookupBtn">Lookup</button>

  <div id="notFound" class="not-found" style="display:none;">Commodity not found.</div>

  <table id="resultsTable" style="display:none;">
    <thead>
      <tr>
        <th>Name</th>
        <th>Code</th>
        <th>Buy Price (SCU)</th>
        <th>Sell Price (SCU)</th>
      </tr>
    </thead>
    <tbody id="resultsBody"></tbody>
  </table>

<script>
  function getCookie(name) {
    const v = document.cookie.split('; ').find(row => row.startsWith(name + '='));
    return v ? decodeURIComponent(v.split('=')[1]) : null;
  }

  function getUEXKey() {
    const cookie = getCookie("profileData");
    if (!cookie) return null;
    try {
      return JSON.parse(cookie).uexKey || null;
    } catch {
      return null;
    }
  }

  async function lookupCommodity(query) {
    const apiKey = getUEXKey();
    if (!apiKey) return alert("UEX API key missing—please set it in Profile.html first.");

    const url = 'https://api.uexcorp.space/2.0/commodities';
    try {
      const res = await fetch(url, {
        headers: { "Authorization": `Bearer ${apiKey}`, "Accept": "application/json" }
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const body = await res.json();
      if (body.status !== 'ok' || !Array.isArray(body.data)) throw new Error("Unexpected API response.");
      
      return body.data.find(item =>
        item.name.toLowerCase() === query ||
        item.code.toLowerCase() === query ||
        item.slug?.toLowerCase() === query
      );
    } catch (err) {
      console.error(err);
      alert("Failed to fetch commodities. Check console for details.");
    }
  }

  async function onLookup() {
    const raw = document.getElementById("commodityInput").value.trim().toLowerCase();
    if (!raw) return alert("Please enter a commodity name or code.");
    document.getElementById("notFound").style.display = 'none';
    document.getElementById("resultsTable").style.display = 'none';

    const item = await lookupCommodity(raw);
    if (!item) {
      document.getElementById("notFound").style.display = 'block';
      return;
    }

    const tbody = document.getElementById("resultsBody");
    tbody.innerHTML = `
      <tr>
        <td>${item.name}</td>
        <td>${item.code}</td>
        <td>${item.price_buy != null ? item.price_buy : '—'}</td>
        <td>${item.price_sell != null ? item.price_sell : '—'}</td>
      </tr>`;
    document.getElementById("resultsTable").style.display = 'table';
  }

  document.getElementById("lookupBtn").onclick = onLookup;
</script>
</body>
</html>
