<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Work Order Overview</title>
<style>
  body {
    background-color: #111;
    color: white;
    font-family: Arial, sans-serif;
    padding: 2rem;
  }
  h1 { color: gold; margin-bottom: 1rem; }
  h2 { color: lightblue; margin: 0 0 0.5rem 0; }
  .container { display: flex; gap: 1rem; margin-bottom: 2rem; }
  .list {
    flex: 1;
    background-color: #222;
    border: 1px solid #555;
    border-radius: 8px;
    padding: 1rem;
    overflow-y: auto;
    max-height: 400px;
  }
  .work-order {
    border-bottom: 1px solid #444;
    padding: 0.5rem 0;
  }
  .work-order:last-child { border-bottom: none; }
  .order-header {
    cursor: pointer;
    font-weight: bold;
    padding: 0.35rem;
    background-color: #333;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }
  .order-header:hover { background-color: #444; }
  .toggle-icon {
    display:inline-block;
    width: 20px;
    text-align: center;
    font-weight: bold;
    color: gold;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0.5rem;
  }
  th, td {
    border: 1px solid #444;
    padding: 0.3rem;
    font-size: 0.85rem;
  }
  th { background-color: #333; }
  button {
    padding: 0.35rem 0.6rem;
    font-size: 0.9rem;
    border-radius: 5px;
    border: 1px solid #555;
    background-color: #333;
    color: white;
    cursor: pointer;
    margin-top: 0.5rem;
  }
  button:hover { background-color: #555; }
  .grand-total { margin-top: 0.5rem; font-weight: bold; color: gold; }
  .bottom-list {
    background-color: #222;
    border: 1px solid #555;
    border-radius: 8px;
    padding: 1rem;
    max-height: 200px;
    overflow-y: auto;
  }
  .hidden { display: none; }
  /* small responsive tweak */
  @media (max-width: 800px) {
    .container { flex-direction: column; }
  }
</style>
</head>
<body>

<h1>Work Order Overview</h1>

<div class="container">
  <div class="list" id="availableList">
    <h2>Available Work Orders</h2>
  </div>

  <div class="list" id="activeList">
    <h2>Active Work Orders</h2>
  </div>
</div>

<div class="bottom-list" id="completedList">
  <h2>Completed Work Orders</h2>
</div>

<script>
  const availableList = document.getElementById("availableList");
  const activeList = document.getElementById("activeList");
  const completedList = document.getElementById("completedList");

  let availableOrders = [];
  let activeOrders = [];
  let completedOrders = [];
  let expandedKey = null; // currently open key
  let orderElementMap = {}; // maps key -> { div, tableSection, icon }

  function formatNumber(num) {
    return Number(num).toLocaleString();
  }

  function renderManifestTable(manifest) {
    const wrapper = document.createElement("div");
    wrapper.className = "manifest-table hidden";
    manifest.categories.forEach(category => {
      const catTitle = document.createElement("h4");
      catTitle.textContent = category.category;
      wrapper.appendChild(catTitle);

      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th>Item</th>
            <th>Qty</th>
            <th>Location</th>
            <th>SCU</th>
            <th>Unit Price</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          ${category.items.map(item => `
            <tr>
              <td>${item.item}</td>
              <td>${formatNumber(item.qty)}</td>
              <td>${item.location}</td>
              <td>${item.scuType ? item.scuType.toUpperCase() : ''}</td>
              <td>${formatNumber(item.unitPrice)}</td>
              <td>${formatNumber(item.total)}</td>
            </tr>
          `).join("")}
        </tbody>
      `;
      wrapper.appendChild(table);
    });

    const totalDiv = document.createElement("div");
    totalDiv.className = "grand-total";
    totalDiv.textContent = `Grand Total: ${formatNumber(manifest.grandTotal)} aUEC`;
    wrapper.appendChild(totalDiv);

    return wrapper;
  }

  function renderLists() {
    // clear map
    orderElementMap = {};

    // AVAILABLE
    availableList.innerHTML = "<h2>Available Work Orders</h2>";
    if (availableOrders.length === 0) {
      availableList.innerHTML += "<p>No available work orders</p>";
    } else {
      availableOrders.forEach(order => {
        const div = document.createElement("div");
        div.className = "work-order";
        div.dataset.key = order.key;

        const header = document.createElement("div");
        header.className = "order-header";
        const icon = document.createElement("span");
        icon.className = "toggle-icon";
        icon.textContent = expandedKey === order.key ? "−" : "+";
        const headerText = document.createElement("span");
        headerText.textContent = `${order.title} — Saved: ${new Date(order.dateSaved).toLocaleString()}`;
        header.appendChild(icon);
        header.appendChild(headerText);
        header.onclick = () => toggleManifest(order.key);

        const tableSection = renderManifestTable(order);

        const btn = document.createElement("button");
        btn.textContent = "Activate";
        btn.onclick = (e) => {
          e.stopPropagation();
          activateOrder(order.key);
        };
        tableSection.appendChild(btn);

        div.appendChild(header);
        div.appendChild(tableSection);
        availableList.appendChild(div);

        orderElementMap[order.key] = { div, tableSection, icon };
      });
    }

    // ACTIVE
    activeList.innerHTML = "<h2>Active Work Orders</h2>";
    if (activeOrders.length === 0) {
      activeList.innerHTML += "<p>No active work orders</p>";
    } else {
      activeOrders.forEach(order => {
        const div = document.createElement("div");
        div.className = "work-order";
        div.dataset.key = order.key;

        const header = document.createElement("div");
        header.className = "order-header";
        const icon = document.createElement("span");
        icon.className = "toggle-icon";
        icon.textContent = expandedKey === order.key ? "−" : "+";
        const headerText = document.createElement("span");
        headerText.textContent = order.title;
        header.appendChild(icon);
        header.appendChild(headerText);
        header.onclick = () => toggleManifest(order.key);

        const tableSection = renderManifestTable(order);

        const btn = document.createElement("button");
        btn.textContent = "Complete";
        btn.onclick = (e) => {
          e.stopPropagation();
          completeOrder(order.key);
        };
        tableSection.appendChild(btn);

        div.appendChild(header);
        div.appendChild(tableSection);
        activeList.appendChild(div);

        orderElementMap[order.key] = { div, tableSection, icon };
      });
    }

    // COMPLETED (no expand)
    completedList.innerHTML = "<h2>Completed Work Orders</h2>";
    if (completedOrders.length === 0) {
      completedList.innerHTML += "<p>No completed work orders</p>";
    } else {
      completedOrders.forEach(order => {
        const div = document.createElement("div");
        div.className = "work-order";
        div.innerHTML = `<strong>${order.title}</strong> — ${formatNumber(order.grandTotal)} aUEC`;
        completedList.appendChild(div);
      });
    }

    // Ensure the visuals reflect expandedKey after re-render
    updateExpandedVisuals();
  }

  function updateExpandedVisuals() {
    // hide all first
    Object.values(orderElementMap).forEach(({ tableSection, icon }) => {
      tableSection.classList.add("hidden");
      icon.textContent = "+";
    });

    if (expandedKey && orderElementMap[expandedKey]) {
      const node = orderElementMap[expandedKey];
      node.tableSection.classList.remove("hidden");
      node.icon.textContent = "−";
      // keep it visible in the viewport
      node.div.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }
  }

  function toggleManifest(key) {
    // If same key -> collapse
    if (expandedKey === key) {
      const node = orderElementMap[key];
      if (node) {
        node.tableSection.classList.add("hidden");
        node.icon.textContent = "+";
      }
      expandedKey = null;
      return;
    }

    // close previous
    if (expandedKey && orderElementMap[expandedKey]) {
      const prev = orderElementMap[expandedKey];
      prev.tableSection.classList.add("hidden");
      prev.icon.textContent = "+";
    }

    // open new
    const node = orderElementMap[key];
    if (node) {
      node.tableSection.classList.remove("hidden");
      node.icon.textContent = "−";
      expandedKey = key;
      node.div.scrollIntoView({ behavior: "smooth", block: "nearest" });
    } else {
      expandedKey = null;
    }
  }

  function activateOrder(key) {
    const idx = availableOrders.findIndex(o => o.key === key);
    if (idx > -1) {
      activeOrders.push(availableOrders.splice(idx, 1)[0]);
      expandedKey = null;
      renderLists();
    }
  }

  function completeOrder(key) {
    const idx = activeOrders.findIndex(o => o.key === key);
    if (idx > -1) {
      completedOrders.push(activeOrders.splice(idx, 1)[0]);
      expandedKey = null;
      renderLists();
    }
  }

  function loadOrders() {
    const savedManifests = JSON.parse(localStorage.getItem("cargoManifestData")) || {};
    // turn into array with key preserved (key is used for moving items)
    availableOrders = Object.keys(savedManifests).map(k => ({ key: k, ...savedManifests[k] }));
    // start fresh (you could also persist active/completed lists if you want)
    activeOrders = [];
    completedOrders = [];
    renderLists();
  }

  // Run on load
  loadOrders();

  // --- Optional: Expose some quick debug helpers in console ---
  // window._sp = { loadOrders, renderLists, availableOrders, activeOrders, completedOrders };
</script>

</body>
</html>