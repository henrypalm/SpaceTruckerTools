<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Workorder Overview</title>
<link rel="icon" href="/imgs/WorkordersOverviewIcon.ico" type="image/x-icon" />


<link rel="stylesheet" href="css/wip-overlay.css" />
<link rel="stylesheet" href="css/nav.css" />
  
<link rel="stylesheet" href="css/workorders-overview-styles/workorders-styles.css" />

</head>
<body>

<div class="container">

  <h1>Workorder Overview</h1>
  
  <div class="container">
    <div class="list" id="availableList">
      <h2>Available Workorders</h2>
    </div>
  
    <div class="list" id="activeList">
      <h2>Active Workorders</h2>
    </div>
  </div>
  
  <div class="bottom-list" id="completedList">
    <h2>Completed Workorders</h2>
  </div>
</div>

  
<script>
  const availableList = document.getElementById("availableList");
  const activeList = document.getElementById("activeList");
  const completedList = document.getElementById("completedList");

  let availableOrders = [];
  let activeOrders = [];
  let completedOrders = [];

  // NEW: Track multiple expanded keys here
  let expandedKeys = JSON.parse(localStorage.getItem("expandedKeys")) || [];

  let orderElementMap = {}; // maps key -> { div, tableSection, icon }

  function formatNumber(num) {
    return Number(num).toLocaleString();
  }

  function renderManifestTable(manifest) {
    const wrapper = document.createElement("div");
    wrapper.className = "manifest-table hidden";
    manifest.categories.forEach(category => {
      const catTitle = document.createElement("h4");
      catTitle.textContent = category.category;
      wrapper.appendChild(catTitle);

      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th>Item</th>
            <th>Qty</th>
            <th>Location</th>
            <th>SCU</th>
            <th>Unit Price</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          ${category.items.map(item => `
            <tr>
              <td>${item.item}</td>
              <td>${formatNumber(item.qty)}</td>
              <td>${item.location}</td>
              <td>${item.scuType ? item.scuType.toUpperCase() : ''}</td>
              <td>${formatNumber(item.unitPrice)}</td>
              <td>${formatNumber(item.total)}</td>
            </tr>
          `).join("")}
        </tbody>
      `;
      wrapper.appendChild(table);
    });

    const totalDiv = document.createElement("div");
    totalDiv.className = "grand-total";
    totalDiv.textContent = `Grand Total: ${formatNumber(manifest.grandTotal)} aUEC`;
    wrapper.appendChild(totalDiv);

    return wrapper;
  }

  function renderLists() {
    orderElementMap = {}; // reset map

    // AVAILABLE
    availableList.innerHTML = "<h2>Available Workorders</h2>";
    if (availableOrders.length === 0) {
      availableList.innerHTML += "<p>No available workorders</p>";
    } else {
      availableOrders.forEach(order => {
        const div = document.createElement("div");
        div.className = "work-order";
        div.dataset.key = order.key;

        const header = document.createElement("div");
        header.className = "order-header";
        const icon = document.createElement("span");
        icon.className = "toggle-icon";
        // show expanded or collapsed based on expandedKeys
        icon.textContent = expandedKeys.includes(order.key) ? "−" : "+";
        const headerText = document.createElement("span");
        headerText.textContent = `${order.title} — Saved: ${new Date(order.dateSaved).toLocaleString()}`;
        header.appendChild(icon);
        header.appendChild(headerText);
        header.onclick = () => toggleManifest(order.key);

        const tableSection = renderManifestTable(order);

        const btn = document.createElement("button");
        btn.textContent = "Activate";
        btn.onclick = (e) => {
          e.stopPropagation();
          activateOrder(order.key);
        };
        tableSection.appendChild(btn);

        div.appendChild(header);
        div.appendChild(tableSection);
        availableList.appendChild(div);

        orderElementMap[order.key] = { div, tableSection, icon };

        // Show/hide table depending on expandedKeys state
        if (expandedKeys.includes(order.key)) {
          tableSection.classList.remove("hidden");
        }
      });
    }

    // ACTIVE
    activeList.innerHTML = "<h2>Active Workorders</h2>";
    if (activeOrders.length === 0) {
      activeList.innerHTML += "<p>No active workorders</p>";
    } else {
      activeOrders.forEach(order => {
        const div = document.createElement("div");
        div.className = "work-order";
        div.dataset.key = order.key;

        const header = document.createElement("div");
        header.className = "order-header";
        const icon = document.createElement("span");
        icon.className = "toggle-icon";
        icon.textContent = expandedKeys.includes(order.key) ? "−" : "+";
        const headerText = document.createElement("span");
        headerText.textContent = order.title;
        header.appendChild(icon);
        header.appendChild(headerText);
        header.onclick = () => toggleManifest(order.key);

        const tableSection = renderManifestTable(order);

        const btn = document.createElement("button");
        btn.textContent = "Complete";
        btn.onclick = (e) => {
          e.stopPropagation();
          completeOrder(order.key);
        };
        tableSection.appendChild(btn);

        div.appendChild(header);
        div.appendChild(tableSection);
        activeList.appendChild(div);

        orderElementMap[order.key] = { div, tableSection, icon };

        if (expandedKeys.includes(order.key)) {
          tableSection.classList.remove("hidden");
        }
      });
    }

    // COMPLETED (no expand)
    completedList.innerHTML = "<h2>Completed Workorders</h2>";
    if (completedOrders.length === 0) {
      completedList.innerHTML += "<p>No completed work orders</p>";
    } else {
      completedOrders.forEach(order => {
        const div = document.createElement("div");
        div.className = "work-order";
        div.innerHTML = `<strong>${order.title}</strong> — ${formatNumber(order.grandTotal)} aUEC`;
        completedList.appendChild(div);
      });
    }
  }

  function toggleManifest(key) {
    const node = orderElementMap[key];
    if (!node) return;

    const isHidden = node.tableSection.classList.contains("hidden");
    node.tableSection.classList.toggle("hidden");
    node.icon.textContent = isHidden ? "−" : "+";

    if (isHidden) {
      if (!expandedKeys.includes(key)) expandedKeys.push(key);
    } else {
      const idx = expandedKeys.indexOf(key);
      if (idx > -1) expandedKeys.splice(idx, 1);
    }
    localStorage.setItem("expandedKeys", JSON.stringify(expandedKeys));
  }

  function activateOrder(key) {
    const idx = availableOrders.findIndex(o => o.key === key);
    if (idx > -1) {
      activeOrders.push(availableOrders.splice(idx, 1)[0]);
      // Remove from expanded keys to avoid orphan expanded on move
      const expIdx = expandedKeys.indexOf(key);
      if (expIdx > -1) expandedKeys.splice(expIdx, 1);
      localStorage.setItem("expandedKeys", JSON.stringify(expandedKeys));
      renderLists();
    }
  }

  function completeOrder(key) {
    const idx = activeOrders.findIndex(o => o.key === key);
    if (idx > -1) {
      completedOrders.push(activeOrders.splice(idx, 1)[0]);
      const expIdx = expandedKeys.indexOf(key);
      if (expIdx > -1) expandedKeys.splice(expIdx, 1);
      localStorage.setItem("expandedKeys", JSON.stringify(expandedKeys));
      renderLists();
    }
  }

  function loadOrders() {
    const raw = localStorage.getItem("cargoManifestData");
    let savedManifests = {};
  
    try {
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) {
        // Convert array to object keyed by order.key
        savedManifests = {};
        parsed.forEach(order => {
          if (order && order.key) {
            savedManifests[order.key] = order;
          }
        });
      } else if (typeof parsed === "object" && parsed !== null) {
        savedManifests = parsed;
      } else {
        // unexpected data type
        savedManifests = {};
      }
    } catch (e) {
      // JSON parsing failed, reset data
      savedManifests = {};
    }
  
    availableOrders = Object.keys(savedManifests).map(k => ({ key: k, ...savedManifests[k] }));
  
    try {
      activeOrders = JSON.parse(localStorage.getItem("activeOrders")) || [];
    } catch {
      activeOrders = [];
    }
  
    try {
      completedOrders = JSON.parse(localStorage.getItem("completedOrders")) || [];
    } catch {
      completedOrders = [];
    }
  
    console.log("Loaded cargoManifestData:", savedManifests);
    console.log("Available Orders:", availableOrders);
    console.log("Active Orders:", activeOrders);
    console.log("Completed Orders:", completedOrders);
  
    renderLists();
  }

  loadOrders();

</script>

</body>
</html>
